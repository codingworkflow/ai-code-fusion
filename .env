# This file is committed to git no secrets.

#!/usr/bin/env bash

# Vault environment loader wrapper (vault agent based, non-interactive)
# Usage: source .env (never run directly)

set -o pipefail

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "This script must be sourced: source .env" >&2
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGENT_CONFIG_PATH="${VAULT_AGENT_CONFIG_PATH:-${SCRIPT_DIR}/vault-agent-env.hcl}"

tools_domain="${TOOLS_DOMAIN:-}"
tools_domain="${tools_domain#.}"
tools_domain="${tools_domain%.}"

[[ -n "$tools_domain" ]] && export SONAR_URL="${SONAR_URL:-https://sonarqube.${tools_domain}/}"
[[ -n "$tools_domain" ]] && export DTRACK_BASE_URL="${DTRACK_BASE_URL:-https://api-dependencytrack.${tools_domain}/}"

if [[ -z "${VAULT_TOKEN:-}" && -z "${VAULT_TOKEN_FILE:-}" ]]; then
    export VAULT_TOKEN_FILE="/home/vscode/.vault-token"
fi

if [[ -z "${VAULT_TOKEN:-}" && -r "${VAULT_TOKEN_FILE:-$HOME/.vault-token}" ]]; then
    export VAULT_TOKEN="$(tr -d '\r\n' < "${VAULT_TOKEN_FILE:-$HOME/.vault-token}")"
fi

if [[ ! -r "$AGENT_CONFIG_PATH" ]]; then
    echo "Vault agent config not found at $AGENT_CONFIG_PATH" >&2
    return 1
fi

if ! command -v vault >/dev/null 2>&1; then
    echo "Vault CLI is required but not found in PATH" >&2
    return 1
fi

source <(
    vault agent -config="$AGENT_CONFIG_PATH" -log-level=error 2>/dev/null \
    | sed -nE 's/^(SONAR_TOKEN|DTRACK_API_KEY)=/export &/p'
)

if [[ -z "${SONAR_TOKEN:-}" || -z "${DTRACK_API_KEY:-}" ]]; then
    echo "Vault did not provide required secrets: SONAR_TOKEN and DTRACK_API_KEY" >&2
    return 1
fi

DTR_PROJECT_KEY=
DTRACK_PROJECT=ai-code-fusion
DTRACK_PROJECT_VERSION=main

# Local SonarQube defaults (cross-platform, no secrets)
SONAR_PROJECT_KEY=ai-code-fusion
