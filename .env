# This file is committed to git no secrets.

#!/usr/bin/env bash

# Vault environment loader wrapper (vault agent based, non-interactive)
# Usage: source .env (never run directly)

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "This script must be sourced: source .env" >&2
    exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AGENT_CONFIG_PATH="${VAULT_AGENT_CONFIG_PATH:-${SCRIPT_DIR}/vault-agent-env.hcl}"
VAULT_AGENT_RUNTIME_DIR="${VAULT_AGENT_RUNTIME_DIR:-${HOME}/.ai-code-fusion}"
VAULT_AGENT_ENV_FILE="${VAULT_AGENT_ENV_FILE:-${VAULT_AGENT_RUNTIME_DIR}/vault.env}"
VAULT_AGENT_TOKEN_SINK_FILE="${VAULT_AGENT_TOKEN_SINK_FILE:-${VAULT_AGENT_RUNTIME_DIR}/vault-agent-token}"
VAULT_AGENT_TIMEOUT_SECONDS="${VAULT_AGENT_TIMEOUT_SECONDS:-20}"
export VAULT_AGENT_ENV_FILE
export VAULT_AGENT_TOKEN_SINK_FILE

if ! mkdir -p "${VAULT_AGENT_RUNTIME_DIR}"; then
    echo "Unable to create Vault runtime directory ${VAULT_AGENT_RUNTIME_DIR}" >&2
    return 1
fi
chmod 700 "${VAULT_AGENT_RUNTIME_DIR}" 2>/dev/null || true

tools_domain="${TOOLS_DOMAIN:-}"
tools_domain="${tools_domain#.}"
tools_domain="${tools_domain%.}"

[[ -n "$tools_domain" ]] && export SONAR_URL="${SONAR_URL:-https://sonarqube.${tools_domain}/}"
[[ -n "$tools_domain" ]] && export DTRACK_BASE_URL="${DTRACK_BASE_URL:-https://api-dependencytrack.${tools_domain}/}"

if [[ -z "${VAULT_TOKEN:-}" && -z "${VAULT_TOKEN_FILE:-}" ]]; then
    export VAULT_TOKEN_FILE="${HOME}/.vault-token"
fi

if [[ -z "${VAULT_TOKEN:-}" && -r "${VAULT_TOKEN_FILE:-$HOME/.vault-token}" ]]; then
    export VAULT_TOKEN="$(tr -d '\r\n' < "${VAULT_TOKEN_FILE:-$HOME/.vault-token}")"
fi

if [[ ! -r "$AGENT_CONFIG_PATH" ]]; then
    echo "Vault agent config not found at $AGENT_CONFIG_PATH" >&2
    return 1
fi

if ! command -v vault >/dev/null 2>&1; then
    echo "Vault CLI is required but not found in PATH" >&2
    return 1
fi

rm -f "$VAULT_AGENT_ENV_FILE"
if command -v timeout >/dev/null 2>&1; then
    timeout "${VAULT_AGENT_TIMEOUT_SECONDS}" vault agent -config="$AGENT_CONFIG_PATH" -log-level=error >/dev/null
    vault_agent_status=$?
    if [[ "$vault_agent_status" -ne 0 ]]; then
        if [[ "$vault_agent_status" -eq 124 ]]; then
            echo "Vault agent timed out after ${VAULT_AGENT_TIMEOUT_SECONDS}s" >&2
        else
            echo "Vault agent failed (exit code: $vault_agent_status)" >&2
        fi
        return 1
    fi
else
    vault agent -config="$AGENT_CONFIG_PATH" -log-level=error >/dev/null
    vault_agent_status=$?
    if [[ "$vault_agent_status" -ne 0 ]]; then
        echo "Vault agent failed (exit code: $vault_agent_status)" >&2
        return 1
    fi
fi

if [[ ! -r "$VAULT_AGENT_ENV_FILE" ]]; then
    echo "Vault agent did not produce $VAULT_AGENT_ENV_FILE" >&2
    return 1
fi

source "$VAULT_AGENT_ENV_FILE"
rm -f "$VAULT_AGENT_ENV_FILE"

if [[ -z "${SONAR_TOKEN:-}" || -z "${DTRACK_API_KEY:-}" ]]; then
    echo "Vault did not provide required secrets: SONAR_TOKEN and DTRACK_API_KEY" >&2
    return 1
fi

DTR_PROJECT_KEY=
DTRACK_PROJECT=ai-code-fusion
DTRACK_PROJECT_VERSION=main

# Local SonarQube defaults (cross-platform, no secrets)
SONAR_PROJECT_KEY=ai-code-fusion
