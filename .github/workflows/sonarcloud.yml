name: SonarCloud QA Gate

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        continue-on-error: true
        run: npm test -- --coverage --runInBand

      - name: Ensure coverage report exists
        run: |
          if [ ! -f coverage/lcov.info ]; then
            mkdir -p coverage
            touch coverage/lcov.info
          fi

      - name: Fetch Sonar token from Vault via GitHub OIDC
        id: vault
        env:
          VAULT_ADDR: ${{ vars.AI_REVIEW_VAULT_ADDR }}
          VAULT_JWT_AUTH_PATH: ${{ vars.AI_REVIEW_VAULT_JWT_AUTH_PATH || 'jwt' }}
          VAULT_JWT_ROLE: ${{ vars.AI_REVIEW_VAULT_JWT_ROLE }}
          VAULT_JWT_AUDIENCE: ${{ vars.AI_REVIEW_VAULT_JWT_AUDIENCE || 'vault' }}
          VAULT_NAMESPACE: ${{ vars.AI_REVIEW_VAULT_NAMESPACE }}
          SECRET_PATH: ${{ vars.AI_REVIEW_VAULT_SONAR_PATH || 'kv/Sonarqube/sonarqube' }}
          SECRET_FIELD: ${{ vars.AI_REVIEW_VAULT_SONAR_FIELD || 'SONAR_TOKEN' }}
        run: |
          set -euo pipefail

          missing=0
          for key in VAULT_ADDR VAULT_JWT_AUTH_PATH VAULT_JWT_ROLE VAULT_JWT_AUDIENCE SECRET_PATH SECRET_FIELD; do
            if [ -z "${!key}" ]; then
              echo "Missing required repository variable backing: ${key}"
              missing=1
            fi
          done

          if [ "${missing}" -ne 0 ]; then
            exit 1
          fi

          oidc_token="$(curl -fsSL -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${VAULT_JWT_AUDIENCE}" | jq -r '.value')"
          if [ -z "${oidc_token}" ] || [ "${oidc_token}" = "null" ]; then
            echo "Failed to retrieve GitHub OIDC token for Vault auth."
            exit 1
          fi

          ns_args=()
          if [ -n "${VAULT_NAMESPACE:-}" ]; then
            ns_args=(-H "X-Vault-Namespace: ${VAULT_NAMESPACE}")
          fi

          vault_token="$(jq -cn --arg role "${VAULT_JWT_ROLE}" --arg jwt "${oidc_token}" '{role:$role,jwt:$jwt}' | curl -fsSL -X POST "${ns_args[@]}" -H "Content-Type: application/json" --data-binary @- "${VAULT_ADDR}/v1/auth/${VAULT_JWT_AUTH_PATH}/login" | jq -r '.auth.client_token')"
          if [ -z "${vault_token}" ] || [ "${vault_token}" = "null" ]; then
            echo "Vault JWT login failed for role '${VAULT_JWT_ROLE}'."
            exit 1
          fi

          secret_path="${SECRET_PATH#/}"
          mount="${secret_path%%/*}"
          path="${secret_path#*/}"
          if [ "${mount}" = "${path}" ]; then
            echo "SECRET_PATH must be in '<mount>/<path>' format, got '${SECRET_PATH}'."
            exit 1
          fi

          sonar_token="$(curl -fsSL "${ns_args[@]}" -H "X-Vault-Token: ${vault_token}" "${VAULT_ADDR}/v1/${mount}/data/${path}" | jq -r --arg field "${SECRET_FIELD}" '.data.data[$field] // empty')"
          if [ -z "${sonar_token}" ]; then
            echo "Failed to read SONAR token from Vault path '${SECRET_PATH}' field '${SECRET_FIELD}'."
            exit 1
          fi

          echo "::add-mask::${vault_token}"
          echo "::add-mask::${sonar_token}"
          echo "sonar_token=${sonar_token}" >> "${GITHUB_OUTPUT}"

      - name: SonarCloud scan
        continue-on-error: true
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ steps.vault.outputs.sonar_token }}
        with:
          args: >
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.organization=${{ vars.SONAR_ORGANIZATION || 'codingworkflow' }}
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY || 'codingworkflow_ai-code-fusion' }}
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.exclusions=tests/**,**/*.test.js,**/*.test.jsx,**/*.test.ts,**/*.test.tsx,**/*.spec.js,**/*.spec.jsx,**/*.spec.ts,**/*.spec.tsx
            -Dsonar.cpd.exclusions=tests/**,**/*.test.js,**/*.test.jsx,**/*.test.ts,**/*.test.tsx,**/*.spec.js,**/*.spec.jsx,**/*.spec.ts,**/*.spec.tsx,src/**/__tests__/**

      - name: SonarCloud quality gate
        continue-on-error: true
        uses: SonarSource/sonarqube-quality-gate-action@cf038b0e0cdecfa9e56c198bbb7d21d751d62c3b
        with:
          scanMetadataReportFile: .scannerwork/report-task.txt
        env:
          SONAR_TOKEN: ${{ steps.vault.outputs.sonar_token }}
          SONAR_HOST_URL: https://sonarcloud.io
        timeout-minutes: 5
