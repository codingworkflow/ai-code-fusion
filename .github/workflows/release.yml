name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Check out Git repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 20
          package-manager-cache: false

      - name: Install dependencies
        run: npm ci

      - name: Prepare build
        run: node scripts/prepare-build.js windows

      - name: Build Webpack
        run: npm run build:webpack

      - name: Build Windows Package
        run: npm run build:win -- --publish=never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: windows-artifacts
          path: |
            dist/*.exe
            dist/*.msi
            dist/*.yml
            dist/*.blockmap
          retention-days: 5

  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out Git repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 20
          package-manager-cache: false

      - name: Install dependencies
        run: npm ci

      - name: Install required system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libnotify-dev libnss3 libxss1 libgbm-dev

      # Skip prepare-build for Linux as it seems to be causing issues
      # Instead, directly modify package.json for Linux build

      - name: Configure Linux Build
        run: |
          # Create a minimal electron-builder config for Linux
          node -e "
            const fs = require('fs');
            const path = require('path');
            const packageJsonPath = path.join(process.cwd(), 'package.json');
            const packageJson = require(packageJsonPath);

            // Remove any existing Linux configuration
            if (packageJson.build && packageJson.build.linux) {
              delete packageJson.build.linux;
            }

            // Set minimal Linux config without any icon reference
            if (!packageJson.build) packageJson.build = {};
            packageJson.build.linux = {
              target: ['AppImage'],
              category: 'Utility'
            };

            fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2) + '\n');
          "

      - name: Build Webpack
        run: npm run build:webpack

      - name: Build Linux AppImage
        run: npm run build -- --linux AppImage --publish=never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: linux-artifacts
          path: |
            dist/*.AppImage
            dist/*.AppImage.zsync
            dist/*.yml
            dist/*.blockmap
          retention-days: 5

  build-macos:
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - name: Check out Git repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: 20
          package-manager-cache: false

      - name: Install dependencies
        run: npm ci

      - name: Prepare build
        run: node scripts/prepare-build.js mac

      - name: Build Webpack
        run: npm run build:webpack

      - name: Build macOS Universal Binary
        run: npm run build:mac-universal -- --publish=never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: macos-artifacts
          path: |
            dist/*.dmg
            dist/*.zip
            dist/*.yml
            dist/*.blockmap
          retention-days: 5

  create-release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out Git repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Validate tag matches package version
        run: |
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          TAG_VERSION="${TAG_VERSION#v}"
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"

          if [[ "${TAG_VERSION}" != "${PACKAGE_VERSION}" ]]; then
            echo "::error::Tag version (${TAG_VERSION}) does not match package.json version (${PACKAGE_VERSION})."
            exit 1
          fi

      - name: Get Changelog Entry
        id: changelog_reader
        uses: mindsers/changelog-reader-action@32aa5b4c155d76c94e4ec883a223c947b2f02656
        with:
          validation_level: warn
          path: ./CHANGELOG.md
          version: ${{ steps.get_version.outputs.VERSION }}
        continue-on-error: true

      - name: Download Windows artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: windows-artifacts
          path: artifacts/windows

      - name: Download Linux artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: linux-artifacts
          path: artifacts/linux

      - name: Download macOS artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: macos-artifacts
          path: artifacts/macos

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.changelog_reader.outputs.changes || 'No changelog provided' }}
          draft: ${{ !contains(steps.get_version.outputs.VERSION, '-alpha') }}
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-alpha') }}
          files: |
            artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
